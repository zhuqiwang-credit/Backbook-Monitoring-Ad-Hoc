use warehouse shared_l;
use database prod__workspace__us;
use schema SCRATCH_T_CREDITANALYTICS;

select top 1000 * from prod__us.dbt_analytics.loan_status_daily_effective where charge_ari in ('0000-1BH9') 
order by servicing_effective_date;

select min(servicing_effective_date) from prod__us.dbt_analytics.loan_status_daily_effective;

select top 1000 * from prod__us.dbt_analytics.loan_status_daily_effective
where is_autopay in ('TRUE') and year(servicing_effective_date)=2023;


---Autopay Monitoring

--loan informaiton
create or replace table PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.loan_info as
select charge_ari, prod,zp_ib,is_repeat_cap,
case when max(itac) <=94 then '<=94'
     when max(itac) between 95 and 96 then '95-96'
     when max(itac) between 97 and 98 then '97-98'
     when max(itac) >98 then '99-100'
     when max(itac) is null then null 
     else 'error' end as itac_band,
case when max(fico_score) <580 then '<580 Deep_Sub_Prime'
     when max(fico_score) between 580 and 619 then '<620 Subprime'
     when max(fico_score) between 620 and 699 then '<700 Near_Prime'
     when max(fico_score) between 700 and 739 then '<740 Prime'
     when max(fico_score) >= 740 then '>=740 Super_Prime'
     else null end as fico_band
from PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.Loan_Level_Information
group by 1,2,3,4
;

select distinct prod from loan_info;

create or replace table PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.raw_weekly_ap_info as 
select a.charge_ari,
a.servicing_effective_date,
case when a.days_overdue>=120 then 'B5'
     when a.days_overdue between 90 and 119 then 'B4'
     when a.days_overdue between 60 and 89 then 'B3'
     when a.days_overdue between 30 and 59 then 'B2'
     when a.days_overdue between 7 and 29 then 'B1'
     when a.days_overdue between 0 and 6 then 'B0'
     else null end as bucket,
a.running_principal_balance,
b.prod,
b.zp_ib,
b.is_repeat_cap,
b.itac_band,
b.fico_band,
case when a.is_autopay in ('TRUE') then 1
     when a.is_autopay in ('FALSE') then 0
     else null end as auto_pay_ind
from prod__us.dbt_analytics.loan_status_daily_effective a
left join PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.loan_info b
on a.charge_ari=b.charge_ari
where dayofweek(servicing_effective_date) =1
and b.prod in ('AC IL','Core IL')
and running_principal_balance>0
and year(servicing_effective_date)>=2023;

select top 1000 * from PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.raw_weekly_ap_info;

--append last week ap_info
create or replace table PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.weekly_ap_driver as
select *,
lag(auto_pay_ind,1) over (partition by charge_ari order by servicing_effective_date) as auto_pay_ind_lw,
case when auto_pay_ind_lw-auto_pay_ind>0 then 1 
     when auto_pay_ind_lw-auto_pay_ind=0 then 0
     else 0 end as ap_off_ind
from PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.raw_weekly_ap_info
;

select top 1000 * from weekly_ap_driver where charge_ari in ('6FDX-DAFH') order by 2;


--All conditions in segmentation, too large to put in sheets (67k rows)
select 
weekofyear(servicing_effective_date) as woy,
year(servicing_effective_date) as yr,
bucket,
zp_ib,
is_repeat_cap,
itac_band,
fico_band,
sum(ap_off_ind) as switch_off,
sum(nullif(auto_pay_ind_lw,0)) as ap_on_lw
from weekly_ap_driver
where fico_band is not null and itac_band is not null
group by 1,2,3,4,5,6,7
order by 1,2,3,4,5,6,7;

--ITAC Bands
select 
weekofyear(servicing_effective_date) as woy,
year(servicing_effective_date) as yr,
itac_band,
sum(ap_off_ind) as switch_off,
sum(nullif(auto_pay_ind_lw,0)) as ap_on_lw
from weekly_ap_driver
where itac_band is not null
and servicing_effective_date<date_trunc(week,current_date)
group by 1,2,3
order by 2,1,3;

--FICO Bands
select 
weekofyear(servicing_effective_date) as woy,
year(servicing_effective_date) as yr,
fico_band,
sum(ap_off_ind) as switch_off,
sum(nullif(auto_pay_ind_lw,0)) as ap_on_lw
from PROD__WORKSPACE__US.SCRATCH_T_CREDITANALYTICS.weekly_ap_driver
where fico_band is not null
and servicing_effective_date<date_trunc(week,current_date)
group by 1,2,3
order by 2,1,3;




